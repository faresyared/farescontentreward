// ... (Your existing server.js code, including requires, app.use, session setup, mongoose connection, and User schema) ...

// Define a user schema using Mongoose (already exists in your server.js)
const userSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    email: { type: String, required: true, unique: true },
    password: { type: String, required: true } // This will store the HASHED password
});

const User = mongoose.model('User', userSchema);


// Sign-up route (POST method to handle user registration) - (already exists in your server.js)
app.post('/signup', async (req, res) => {
    const { username, email, password } = req.body;

    try {
        const existingUser = await User.findOne({ $or: [{ username: username }, { email: email }] });
        if (existingUser) {
            const errorType = existingUser.username === username ? 'usernameexists' : 'emailexists';
            return res.redirect(`/signup?error=${errorType}`);
        }

        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        const newUser = new User({ username, email, password: hashedPassword });
        await newUser.save();

        res.redirect('/?signupSuccess=true'); // Redirect to Sign In page with success flag
    } catch (err) {
        console.error('Error during user signup:', err);
        res.redirect('/signup?error=servererror');
    }
});

// Sign-in route (POST method to handle user login) - (already exists in your server.js)
app.post('/signin', async (req, res) => {
    const { username, password } = req.body;

    try {
        const user = await User.findOne({ username });

        if (user) {
            const isMatch = await bcrypt.compare(password, user.password);

            if (isMatch) {
                req.session.user = { id: user._id, username: user.username };
                return res.redirect('/mainpage'); // *** IMPORTANT: Redirect to /mainpage on successful login ***
            }
        }
        res.redirect('/?error=true');
    } catch (err) {
        console.error('Error during user signin:', err);
        res.redirect('/?error=servererror');
    }
});

// Serve the Sign In page when visiting the root URL (/) - (already exists in your server.js)
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Serve the Sign Up page when visiting the /signup URL - (already exists in your server.js)
app.get('/signup', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'signup.html'));
});

// *** NEW ROUTE: Serve the Main Page (Dashboard) ***
app.get('/mainpage', (req, res) => {
    // Check if the user is logged in
    if (req.session.user) {
        res.sendFile(path.join(__dirname, 'public', 'mainpage.html')); // Serve the main page HTML
    } else {
        // If not logged in, redirect to the sign-in page or show an unauthorized message
        res.status(401).send('You must be logged in to view this page. <a href="/">Go to Sign In</a>');
    }
});

// ... (Your server.listen code at the end of server.js) ...
const port = process.env.PORT || 3000;
app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
});
