<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --background-dark: #343a40;
            --card-background: #ffffff;
            --text-color-light: #333;
            --text-color-dark: #eee;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: var(--background-light);
            color: var(--text-color-light);
            overflow-x: hidden;
        }

        /* --- Sidebar Styling --- */
        .sidebar {
            width: 250px;
            background-color: var(--background-dark);
            color: var(--text-color-dark);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px var(--shadow-color);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .sidebar-header h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
            color: var(--primary-color);
        }

        .sidebar-menu {
            flex-grow: 1;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-color-dark);
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .sidebar-menu li a svg {
            margin-right: 15px;
            fill: currentColor;
            width: 20px;
            height: 20px;
        }

        /* Admin-specific styling */
        .sidebar-menu li.admin-only {
            display: none;
        }
        .sidebar-menu li.admin-only.show {
            display: block;
        }


        .sidebar-footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-footer button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .sidebar-footer button:hover {
            background-color: #5a6268;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 250px;
            transition: margin-left 0.3s ease-in-out;
        }

        .main-content.shifted {
            margin-left: 0;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--card-background);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .topbar h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            color: var(--primary-color);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-color-light);
        }

        .content-section {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }

        .content-section h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Form styling for Add Campaign */
        .add-campaign-form .form-group {
            margin-bottom: 15px;
        }

        .add-campaign-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .add-campaign-form input[type="text"],
        .add-campaign-form textarea,
        .add-campaign-form input[type="date"],
        .add-campaign-form input[type="number"],
        .add-campaign-form select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .add-campaign-form input[type="file"] {
            padding: 10px 0;
        }

        .add-campaign-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .add-campaign-form button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            margin-top: 15px;
        }

        .add-campaign-form button:hover {
            background-color: #218838;
        }

        #addCampaignMessage {
            margin-top: 15px;
            font-weight: bold;
            color: red;
        }
        #addCampaignMessage.success {
            color: green;
        }

        /* Profile Section specific styles */
        .profile-info p {
            margin-bottom: 10px;
        }
        .profile-photo-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .profile-photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
            border: 2px solid var(--primary-color);
            background-color: #f0f0f0; /* Placeholder background */
        }
        .profile-photo-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-photo-input-group label {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 10px;
        }
        .profile-photo-input-group label:hover {
            background-color: #0056b3;
        }
        .profile-photo-input-group input[type="file"] {
            display: none; /* Hide default file input */
        }
        #uploadPhotoMessage {
            margin-top: 10px;
            font-weight: bold;
            color: red;
        }
        #uploadPhotoMessage.success {
            color: green;
        }

        /* Campaign List Display */
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .campaign-card {
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .campaign-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .campaign-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            border-bottom: 1px solid var(--border-color);
        }

        .campaign-card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes budget/pay to bottom */
        }

        .campaign-card-content h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.3em;
            font-weight: 600;
        }

        .campaign-card-content p {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.95em;
            color: var(--text-color-light);
        }

        .campaign-card-content .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px; /* Spacing for budget/pay */
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }

        .campaign-card-content .info-item {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .campaign-card-content .info-item span {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
                transform: translateX(-100%);
            }
            .sidebar.collapsed {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            .topbar {
                padding: 10px 15px;
            }
            .menu-toggle {
                display: block;
            }
            .sidebar + .main-content {
                margin-left: 0;
            }
            .campaigns-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .topbar h2 {
                font-size: 1.5em;
            }
            .content-section {
                padding: 20px;
            }
            .campaigns-grid {
                grid-template-columns: 1fr; /* Stack campaigns vertically on very small screens */
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>MyDash</h1>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" data-section="campaigns">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                Campaigns
            </a></li>
            <li><a href="#" data-section="chat">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Chat
            </a></li>
            <li><a href="#" data-section="my-campaigns-list">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                My Campaigns List
            </a></li>
            <li class="admin-only" id="add-campaign-sidebar-link"><a href="#" data-section="add-campaign">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add New Campaign
            </a></li>
            <li><a href="#" data-section="profile">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Profile
            </a></li>
        </ul>
        <div class="sidebar-footer">
            <button id="logoutButton">Logout</button>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <div class="topbar">
            <button class="menu-toggle" id="menuToggle">&#9776;</button>
            <h2 id="currentPageTitle">Campaigns</h2>
            <div><span id="userNameDisplay">User Name</span> (<span id="userRoleDisplay">User</span>)</div>
        </div>

        <div id="campaigns-section" class="content-section">
            <h3>All Available Campaigns</h3>
            <div id="campaignsGrid" class="campaigns-grid">
                <p id="loadingCampaigns">Loading campaigns...</p>
                <p id="noCampaigns" style="display:none;">No campaigns available yet. Check back soon!</p>
            </div>
        </div>

        <div id="chat-section" class="content-section" style="display: none;">
            <h3>Chat Interface</h3>
            <p>Communicate with your team or customers here.</p>
            <p>Recent conversations...</p>
        </div>

        <div id="my-campaigns-list-section" class="content-section" style="display: none;">
            <h3>My Campaigns List</h3>
            <p>A list of campaigns you are actively involved in.</p>
            <p>Your active campaigns will appear here...</p>
        </div>

        <div id="add-campaign-section" class="content-section admin-only" style="display: none;">
            <h3>Add New Campaign</h3>
            <form id="addCampaignForm" class="add-campaign-form">
                <div class="form-group">
                    <label for="campaignName">Campaign Name:</label>
                    <input type="text" id="campaignName" name="campaignName" required>
                </div>
                <div class="form-group">
                    <label for="campaignDescription">Description:</label>
                    <textarea id="campaignDescription" name="campaignDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="campaignPhoto">Campaign Photo:</label>
                    <input type="file" id="campaignPhoto" name="campaignPhoto" accept="image/*" required>
                    <img id="campaignPhotoPreview" style="max-width: 150px; max-height: 150px; margin-top: 10px; border: 1px solid #ddd; display: none;" src="" alt="Campaign Photo Preview">
                </div>
                <div class="form-group">
                    <label for="campaignCategory">Category:</label>
                    <select id="campaignCategory" name="campaignCategory" required>
                        <option value="">Select a Category</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="trading">Trading</option>
                        <option value="motivational">Motivational</option>
                        <option value="brands">Brands</option>
                        <option value="ugc">UGC (User Generated Content)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customerRules">Rules for Customers (one per line):</label>
                    <textarea id="customerRules" name="customerRules" placeholder="Rule 1&#10;Rule 2&#10;..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="associatedFiles">Associated Files/Links (e.g., YouTube URL, Google Drive URL, Instagram Post URL - one per line):</label>
                    <textarea id="associatedFiles" name="associatedFiles" placeholder="https://www.youtube.com/watch?v=xyz&#10;https://drive.google.com/folder/abc&#10;https://www.instagram.com/p/123&#10;https://www.tiktok.com/@user/video/123" required></textarea>
                </div>
                <div class="form-group">
                    <label for="clipperPlatforms">Clipper Platforms (comma-separated: insta, tiktok, x, yt):</label>
                    <input type="text" id="clipperPlatforms" name="clipperPlatforms" placeholder="insta, tiktok, yt" required>
                </div>
                <div class="form-group">
                    <label for="remainingBudget">Remaining Budget ($):</label>
                    <input type="number" id="remainingBudget" name="remainingBudget" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="payPer1kViews">Pay per 1K Views ($):</label>
                    <input type="number" id="payPer1kViews" name="payPer1kViews" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="videoExamples">Video Examples (YouTube embed URLs - one per line):</label>
                    <textarea id="videoExamples" name="videoExamples" placeholder="https://www.youtube.com/embed/example1&#10;https://www.youtube.com/embed/example2"></textarea>
                </div>
                <div class="form-group">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" name="endDate" required>
                </div>
                <button type="submit">Create Campaign</button>
            </form>
            <p id="addCampaignMessage"></p>
        </div>

        <div id="profile-section" class="content-section" style="display: none;">
            <h3>User Profile</h3>
            <div class="profile-info">
                <p>Your email: <span id="profileEmail">Loading...</span></p>
                <p>Phone: <span id="profilePhone">Loading...</span></p>
                <p>Country: <span id="profileCountry">Loading...</span></p>
                <p>Role: <span id="profileRole">Loading...</span></p>
            </div>

            <div class="profile-photo-section">
                <h4>Profile Photo</h4>
                <img id="profilePhotoPreview" class="profile-photo-preview" src="https://via.placeholder.com/120?text=No+Photo" alt="Profile Photo">
                <div class="profile-photo-input-group">
                    <label for="profilePhotoInput">Upload Photo</label>
                    <input type="file" id="profilePhotoInput" accept="image/*">
                    <p id="uploadPhotoMessage"></p>
                </div>
            </div>

            <button style="margin-top: 20px;">Edit Profile</button>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const menuToggle = document.getElementById('menuToggle');
        const logoutButton = document.getElementById('logoutButton');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const currentPageTitle = document.getElementById('currentPageTitle');
        const profileEmailSpan = document.getElementById('profileEmail');
        const profilePhoneSpan = document.getElementById('profilePhone');
        const profileCountrySpan = document.getElementById('profileCountry');
        const profileRoleSpan = document.getElementById('profileRole');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const addCampaignSidebarLink = document.getElementById('add-campaign-sidebar-link');
        const addCampaignForm = document.getElementById('addCampaignForm');
        const addCampaignMessage = document.getElementById('addCampaignMessage');

        // Profile Photo elements
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        const profilePhotoPreview = document.getElementById('profilePhotoPreview');
        const uploadPhotoMessage = document.getElementById('uploadPhotoMessage');

        // New Campaign elements
        const campaignPhotoInput = document.getElementById('campaignPhoto');
        const campaignPhotoPreview = document.getElementById('campaignPhotoPreview');
        const campaignsGrid = document.getElementById('campaignsGrid');
        const loadingCampaigns = document.getElementById('loadingCampaigns');
        const noCampaigns = document.getElementById('noCampaigns');


        // --- User Role Check ---
        const isAdmin = localStorage.getItem('isAdmin') === 'true';

        // --- Fetch User Profile Data on Load ---
        async function fetchUserProfile() {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) {
                console.warn('No user email found in localStorage. Redirecting to login.');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`/api/getUserProfile?email=${encodeURIComponent(userEmail)}`);
                const result = await response.json();

                if (response.ok) {
                    const user = result.user;
                    profileEmailSpan.textContent = user.email || 'N/A';
                    profilePhoneSpan.textContent = `${user.phoneCode || ''} ${user.phoneNumber || 'N/A'}`.trim();
                    profileCountrySpan.textContent = user.country || 'N/A';
                    profileRoleSpan.textContent = user.role ? user.role.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) : 'N/A';

                    userNameDisplay.textContent = user.email.split('@')[0];
                    userRoleDisplay.textContent = user.isAdmin ? 'Admin' : (user.role ? user.role.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) : 'User');

                    if (user.profilePhotoUrl) {
                        profilePhotoPreview.src = user.profilePhotoUrl;
                    } else {
                        profilePhotoPreview.src = "https://via.placeholder.com/120?text=No+Photo";
                    }

                } else {
                    console.error('Failed to fetch user profile:', result.message);
                    profileEmailSpan.textContent = 'Error loading profile.';
                }
            } catch (error) {
                console.error('Network error fetching profile:', error);
                profileEmailSpan.textContent = 'Network error.';
            }
        }

        // --- Fetch All Campaigns for Display ---
        async function fetchAllCampaigns() {
            campaignsGrid.innerHTML = ''; // Clear previous campaigns
            loadingCampaigns.style.display = 'block';
            noCampaigns.style.display = 'none';

            try {
                const response = await fetch('/api/getCampaigns'); // New API endpoint
                const result = await response.json();

                if (response.ok && result.campaigns && result.campaigns.length > 0) {
                    loadingCampaigns.style.display = 'none';
                    result.campaigns.forEach(campaign => {
                        const campaignCard = document.createElement('div');
                        campaignCard.className = 'campaign-card';
                        campaignCard.setAttribute('data-id', campaign._id); // Store campaign ID
                        campaignCard.innerHTML = `
                            <img src="${campaign.campaignPhotoUrl || 'https://via.placeholder.com/400x200?text=Campaign+Image'}" alt="${campaign.name}">
                            <div class="campaign-card-content">
                                <h4>${campaign.name}</h4>
                                <p>Category: ${campaign.category.charAt(0).toUpperCase() + campaign.category.slice(1)}</p>
                                <div class="info-row">
                                    <div class="info-item">Budget: <span>$${campaign.remainingBudget.toLocaleString()}</span></div>
                                    <div class="info-item">Pay/1K Views: <span>$${campaign.payPer1kViews}</span></div>
                                </div>
                            </div>
                        `;
                        campaignsGrid.appendChild(campaignCard);

                        // Add click listener to each campaign card
                        campaignCard.addEventListener('click', () => {
                            window.location.href = `campaign-detail.html?id=${campaign._id}`;
                        });
                    });
                } else {
                    loadingCampaigns.style.display = 'none';
                    noCampaigns.style.display = 'block';
                }
            } catch (error) {
                console.error('Network error fetching campaigns:', error);
                loadingCampaigns.style.display = 'none';
                noCampaigns.textContent = 'Failed to load campaigns. Please try again later.';
                noCampaigns.style.display = 'block';
            }
        }


        // --- Conditionally display admin elements and fetch data on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            if (isAdmin) {
                addCampaignSidebarLink.classList.add('show');
                document.getElementById('add-campaign-section').classList.add('show');
            }
            fetchUserProfile(); // Fetch user data when dashboard loads

            // Set Campaigns as active and visible on initial load
            const initialActiveLink = document.querySelector('.sidebar-menu a[data-section="campaigns"]');
            if (initialActiveLink) {
                initialActiveLink.classList.add('active');
                document.getElementById('campaigns-section').style.display = 'block';
                currentPageTitle.textContent = initialActiveLink.textContent.trim();
                fetchAllCampaigns(); // Fetch campaigns when the page loads or Campaigns tab is active
            }
        });


        // --- Toggle Sidebar on Mobile ---
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // --- Show/Hide Content Sections based on Sidebar Click ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();

                sidebarLinks.forEach(item => item.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });

                const targetSectionId = this.getAttribute('data-section') + '-section';
                const targetSection = document.getElementById(targetSectionId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    // If profile section is clicked, re-fetch profile to ensure latest data
                    if (targetSectionId === 'profile-section') {
                        fetchUserProfile();
                    } else if (targetSectionId === 'campaigns-section') {
                        fetchAllCampaigns(); // Re-fetch campaigns when Campaigns tab is clicked
                    }
                }

                currentPageTitle.textContent = this.textContent.trim();

                if (window.innerWidth <= 768) {
                    sidebar.classList.add('collapsed');
                }
            });
        });

        // --- Logout Logic ---
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('isAdmin');
            alert('You have been logged out.');
            window.location.href = 'index.html';
        });

        // --- Campaign Photo Preview ---
        campaignPhotoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    campaignPhotoPreview.src = e.target.result;
                    campaignPhotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                campaignPhotoPreview.src = '';
                campaignPhotoPreview.style.display = 'none';
            }
        });


        // --- Add Campaign Form Submission (Client-side) ---
        addCampaignForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!isAdmin) {
                addCampaignMessage.textContent = 'You do not have permission to add campaigns.';
                addCampaignMessage.className = '';
                return;
            }

            const formData = new FormData();
            formData.append('name', document.getElementById('campaignName').value);
            formData.append('description', document.getElementById('campaignDescription').value);
            formData.append('campaignPhoto', document.getElementById('campaignPhoto').files[0]);
            formData.append('category', document.getElementById('campaignCategory').value);
            formData.append('customerRules', document.getElementById('customerRules').value);
            formData.append('associatedFiles', document.getElementById('associatedFiles').value);
            formData.append('clipperPlatforms', document.getElementById('clipperPlatforms').value);
            formData.append('remainingBudget', document.getElementById('remainingBudget').value);
            formData.append('payPer1kViews', document.getElementById('payPer1kViews').value);
            formData.append('videoExamples', document.getElementById('videoExamples').value);
            formData.append('startDate', document.getElementById('startDate').value);
            formData.append('endDate', document.getElementById('endDate').value);


            addCampaignMessage.textContent = 'Adding campaign...';
            addCampaignMessage.className = '';

            try {
                // This will call the updated /api/addCampaign
                const response = await fetch('/api/addCampaign', {
                    method: 'POST',
                    body: formData // FormData handles Content-Type automatically for file uploads
                });

                const result = await response.json();

                if (response.ok) {
                    addCampaignMessage.textContent = result.message;
                    addCampaignMessage.className = 'success';
                    addCampaignForm.reset();
                    campaignPhotoPreview.src = ''; // Clear photo preview
                    campaignPhotoPreview.style.display = 'none';
                    fetchAllCampaigns(); // Refresh campaigns list
                } else {
                    addCampaignMessage.textContent = result.message || 'Failed to add campaign.';
                    addCampaignMessage.className = '';
                    console.error('Failed to add campaign:', result);
                }
            } catch (error) {
                addCampaignMessage.textContent = 'Network error. Could not add campaign.';
                addCampaignMessage.className = '';
                console.error('Fetch error:', error);
            }
        });

        // --- Profile Photo Upload Logic ---
        profilePhotoInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) {
                uploadPhotoMessage.textContent = '';
                return;
            }

            uploadPhotoMessage.textContent = 'Uploading photo...';
            uploadPhotoMessage.className = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                profilePhotoPreview.src = e.target.result;
            };
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('profilePhoto', file);
            formData.append('email', localStorage.getItem('userEmail'));

            try {
                const response = await fetch('/api/uploadProfilePhoto', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadPhotoMessage.textContent = result.message;
                    uploadPhotoMessage.className = 'success';
                    if (result.profilePhotoUrl) {
                        profilePhotoPreview.src = result.profilePhotoUrl;
                    }
                    fetchUserProfile();
                } else {
                    profilePhotoPreview.src = "https://via.placeholder.com/120?text=Upload+Failed";
                    uploadPhotoMessage.textContent = result.message || 'Failed to upload photo.';
                    uploadPhotoMessage.className = '';
                    console.error('Photo upload failed:', result);
                }
            } catch (error) {
                profilePhotoPreview.src = "https://via.placeholder.com/120?text=Network+Error";
                uploadPhotoMessage.textContent = 'Network error during photo upload.';
                uploadPhotoMessage.className = '';
                console.error('Fetch error during photo upload:', error);
            }
        });

        // Handle initial sidebar state for desktop vs mobile
        function handleSidebarState() {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('collapsed');
                mainContent.style.marginLeft = '0';
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.style.marginLeft = '250px';
            }
        }

        handleSidebarState();
        window.addEventListener('resize', handleSidebarState);
    </script>
</body>
</html>
